<!DOCTYPE html>
<html>
<head>
<meta charset="utf‐8">
<title> Browser Composer </title> 

<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" href="/resources/demos/style.css">
<link rel="stylesheet" href="css/example.css">

<script src="js/jquery.min.js"> </script>
<script src="js/jquery-ui.js"> </script>
<script src="js/jquery.mobile.min.js"> </script>

<!--
<script src="jquery-1.8.3.min.js"></script>
    <script src="ui/jquery.ui.core.js"></script>
    <script src="ui/jquery.ui.widget.js"></script>
    <script src="ui/jquery.ui.mouse.js"></script>
    <script src="ui/jquery.ui.draggable.js"></script>
    <script src="jquery-collision.min.js"></script>
    <script src="jquery-ui-draggable-collision.min.js"></script>


<script src="js/jquery.ui-draggable-collision.js"> </script>
<script src="js/jquery-ui.js"> </script>
<script src="js/jquery.mobile.min.js"> </script>
-->
<script type="text/javascript" src="js/nexusUI.js" ></script>
<script type="text/javascript" src="js/Tone.js" ></script>

<script>


var colorKey = ['red','#CC0099','yellow','#669999','#003399','#990000',  
				'#000099','#ff6600','#660066','#006600','#669999','#003399'];


$( function() {
	var hoveringOverGrid = 0;
	var cursorP = { x: -1, y: -1 };
	var currentObj = null;
	var snapX = 20,snapY=20;
	var widthMode = 40;
	var claimedSpots = [];
	
	function bindDragging(node)
	{
		/*
		$(node).draggable({
			obstacle: ".ui-draggable",
			preventCollision: true,
			containment: "parent",
			grid: [ snapX, snapY ]
		});
		*/
		$(node).mousedown(function(e) 
		{
			if(!currentObj) {
				currentObj = $(this);
				console.log(currentObj);
			}
		}).mouseup(function() 
		{
			currentObj = null;
		});
	}
	function editClickCallback()
	{
		if(currentObj)
		{
			var clone = currentObj.clone(true);
			if(clone)
			{
				clone.appendTo("#gridbox");
				claimedSpots.push({'position':[cursorP.x,cursorP.y],'width':widthMode});
				$(clone).css({'opacity':'1'});
				bindDragging(clone);
			}
		}
	}
	function editHoverOnCallback() {
		//When cursor enters the gridbox
		hoveringOverGrid = true;
		//if($('.ui-draggable-dragging')) return;
		var previewStyle = "background: purple; opacity:0.5; \
						width:"+widthMode+"px; height:"+snapY+"px; \
						top:"+snapY+"px;left:"+snapX+"px; \
						position:absolute;";

        $(this).css({'border':'solid black 1px'})
        var node = document.createElement('div');
        $("#gridbox").append(node);
		$(node).attr('style',previewStyle);
		currentObj = $(node);
	}
	
	function editHoverOffCallback() 
    {
    	//When cursor leaves the gridbox
    	hoveringOverGrid = false;
        $(this).css({'border':'solid red 1px'});
        if(currentObj)
        {
	        currentObj.remove();
    	    currentObj=null;
    	}
    }
    function editCursorCallback(event) 
    {
    	//Move preview object to follow cursor, make it snappable
    	var offset = $("#gridbox").offset();
        cursorP.x = (Math.ceil((event.pageX-offset.left) / snapX)*snapX);
        cursorP.y = (Math.ceil(((event.pageY-offset.top)) / snapY)*snapY);
        
        if (currentObj) {
        	var ix = cursorP.y/20;
        	ix = ix % 12;
        	currentObj.css({'top':cursorP.y-snapY, 'left':cursorP.x-snapX, 'background':colorKey[ix]});
    	}
    	else if($('.iandrags-dragging'))
    	{
    		
    		//console.log(event.pageY-offset.top);
    		//var top = $('.ui-draggable-dragging').css('top')/20;
			//console.log(top);
    		//top = top % 12;

    		//$('.ui-draggable-dragging').css({'background':colorKey[top]});
    	}
    }
    function setEditMode()
    {
    	$('#gridbox').click(editClickCallback);
		$('#gridbox').hover(editHoverOnCallback,editHoverOffCallback);
		$(document).mousemove(editCursorCallback);
    }
    function exitEditMode()
    {
    	$('#gridbox').unbind("click",editClickCallback);
		$('#gridbox').unbind("hover",editHoverOnCallback,editHoverOffCallback);
		$(document).unbind("mousemove",editCursorCallback);
    }
    function setSelectMode()
    {
    	var dragSelector = $(".ui-draggable");
    	dragSelector.selectable();
    	dragSelector.draggable( "destroy" );
    }
	$(document).keyup(function(e) {
		
			switch(e.keyCode)
			{
				case 81: //"q" key
					if(hoveringOverGrid && currentObj)
					{
						currentObj.remove();
						currentObj=null;
					}
					break;
				case 87: //"w" key
					if(widthMode < 8*snapX)
						widthMode = widthMode*2;
					if(currentObj)
						currentObj.css({'width':widthMode});
					break;
				case 69: //"e" key
					if(widthMode > snapX)
						widthMode = widthMode/2;
					if(currentObj)
						currentObj.css({'width':widthMode});	
					break;
				case 90: //"z" key"
					setEditMode();
					break;
				case 88: //"x" key"
					setSelectMode();
					break;
				case 67: //"c" key"
					break;
			}
	});
	setEditMode();
    
} );

  
</script>
      
<script>
	
	/*
	var audioCtx = new (window.AudioContext || window.webkitAudioContext);
	var sinea = audioCtx.createOscillator();
	sinea.frequency.value = 440;
	sinea.type = "sine";
	
	var sampler = new Tone.Player("samples/pluck.wav", function() {
		console.log("samples loaded");
	});
	*/
	var synth = new Tone.PolySynth(4, Tone.MonoSynth, {
	"oscillator" : {
				"partials" : [0, 2, 3, 4],
			}
		}).toMaster();
	synth.set({
		"envelope" : {
			"attack" : 0.1
		}
	});
	
	
	var notes = 
	["b3" ,"c3" ,"c-3" ,"d3" ,"d-3" ,"e3" ,"f3" ,"f-3" ,"g3" ,"g-3" ,
	 "b4" ,"c4" ,"c-4" ,"d4" ,"d-4" ,"e4" ,"f4" ,"f-4" ,"g4" ,"g-4" ,
	 "b5" ,"c5" ,"c-5" ,"d5" ,"d-5" ,"e5" ,"f5" ,"f-5" ,"g5" ,"g-5" ];
	var notesPaths = {
			"b3" : "./samples/b3.mp3",
			"c3" : "./samples/c3.mp3",
			"c-3" : "./samples/c-3.mp3",
			"d3" : "./samples/d3.mp3",
			"d-3" : "./samples/d-3.mp3",
			"e3" : "./samples/e3.mp3",
			"f3" : "./samples/f3.mp3",
			"f-3" : "./samples/f-3.mp3",
			"g3" : "./samples/g3.mp3",
			"g-3" : "./samples/g-3.mp3",
			"b4" : "./samples/b4.mp3",
			"c4" : "./samples/c4.mp3",
			"c-4" : "./samples/c-4.mp3",
			"d4" : "./samples/d4.mp3",
			"d-4" : "./samples/d-4.mp3",
			"e4" : "./samples/e4.mp3",
			"f4" : "./samples/f4.mp3",
			"f-4" : "./samples/f-4.mp3",
			"g4" : "./samples/g4.mp3",
			"g-4" : "./samples/g-4.mp3",
			"b5" : "./samples/b5.mp3",
			"c5" : "./samples/c5.mp3",
			"c-5" : "./samples/c-5.mp3",
			"d5" : "./samples/d5.mp3",
			"d-5" : "./samples/d-5.mp3",
			"e5" : "./samples/e5.mp3",
			"f5" : "./samples/f5.mp3",
			"f-5" : "./samples/f-5.mp3",
			"g5" : "./samples/g5.mp3",
			"g-5" : "./samples/g-5.mp3",
		};
	//sampler.toMaster();
	
	var keys = new Tone.MultiPlayer({
		urls : notesPaths,
		volume : -10,
		fadeOut : 0.1,
    }).toMaster();
	
	var piano = new Tone.PolySynth(4, Tone.Synth, {
		"volume" : -8,
		"oscillator" : {
			"partials" : [1, 2, 1],
		},
		"portamento" : 0.05
	}).toMaster();
	var cChord = ["C4"];
	var dChord = ["D4"];
	var gChord = ["E4"];
	var pianoPart = new Tone.Part(function(time, chord){
		piano.triggerAttackRelease(chord, "8n", time);
	}, [["0:0:0", cChord], ["1:0:0", dChord],]).start("0");

	Tone.Transport.bpm.value = 90;
	Tone.Transport.start();
	nx.onload = function() {
		button1.on('*',function(data) {
			console.log("button pressed!");
			//sequence.start();
			//keys.start(notes[5], time, 0, "32n", 0, vel);
			//sampler.start();
		});
	}
</script>

</head>
<body>

	<div id="gridbox"></div>
	<canvas nx="button"></canvas>
</body>
	
</html>